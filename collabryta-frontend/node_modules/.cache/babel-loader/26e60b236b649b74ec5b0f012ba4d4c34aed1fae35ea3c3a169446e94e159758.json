{"ast":null,"code":"import _objectSpread from\"D:/Collabryta/collabryta-frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{createContext,useContext,useState,useEffect,useCallback,useRef}from'react';import{notificationService}from'../services/notificationService';import{jsx as _jsx}from\"react/jsx-runtime\";const NotificationContext=/*#__PURE__*/createContext(undefined);export const NotificationProvider=_ref=>{let{children}=_ref;const[notifications,setNotifications]=useState([]);const[unreadCount,setUnreadCount]=useState(0);const listeners=useRef({});const subscribe=useCallback((type,callback)=>{if(!listeners.current[type]){listeners.current[type]=[];}listeners.current[type].push(callback);return()=>{listeners.current[type]=listeners.current[type].filter(cb=>cb!==callback);};},[]);const fetchNotifications=useCallback(async()=>{const token=localStorage.getItem('token');if(!token)return;try{const data=await notificationService.getNotifications(0,50);setNotifications(data);setUnreadCount(data.filter(n=>!n.is_read).length);}catch(err){console.error('Error fetching notifications:',err);}},[]);const addNotification=useCallback(notification=>{setNotifications(prev=>[notification,...prev]);setUnreadCount(prev=>prev+1);},[]);const markAsRead=async id=>{try{await notificationService.markAsRead(id);setNotifications(prev=>prev.map(n=>n.id===id?_objectSpread(_objectSpread({},n),{},{is_read:true}):n));setUnreadCount(prev=>Math.max(0,prev-1));}catch(err){console.error('Error marking as read:',err);}};const markAllAsRead=async()=>{try{await notificationService.markAllAsRead();setNotifications(prev=>prev.map(n=>_objectSpread(_objectSpread({},n),{},{is_read:true})));setUnreadCount(0);}catch(err){console.error('Error marking all as read:',err);}};useEffect(()=>{fetchNotifications();const token=localStorage.getItem('token');if(!token)return;const wsUrl=\"ws://localhost:8000/api/v1/ws?token=\".concat(token);let ws;let reconnectTimeout;const connect=()=>{ws=new WebSocket(wsUrl);ws.onmessage=event=>{try{const message=JSON.parse(event.data);if(message.type&&listeners.current[message.type]){listeners.current[message.type].forEach(cb=>cb(message.data));}if(message.type==='notification'){addNotification(message.data);}}catch(err){console.error('Error parsing WS message:',err);}};ws.onclose=()=>{reconnectTimeout=setTimeout(connect,5000);};};connect();return()=>{if(ws)ws.close();clearTimeout(reconnectTimeout);};},[fetchNotifications,addNotification]);return/*#__PURE__*/_jsx(NotificationContext.Provider,{value:{notifications,unreadCount,addNotification,markAsRead,markAllAsRead,subscribe},children:children});};export const useNotifications=()=>{const context=useContext(NotificationContext);if(context===undefined){throw new Error('useNotifications must be used within a NotificationProvider');}return context;};","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","useRef","notificationService","jsx","_jsx","NotificationContext","undefined","NotificationProvider","_ref","children","notifications","setNotifications","unreadCount","setUnreadCount","listeners","subscribe","type","callback","current","push","filter","cb","fetchNotifications","token","localStorage","getItem","data","getNotifications","n","is_read","length","err","console","error","addNotification","notification","prev","markAsRead","id","map","_objectSpread","Math","max","markAllAsRead","wsUrl","concat","ws","reconnectTimeout","connect","WebSocket","onmessage","event","message","JSON","parse","forEach","onclose","setTimeout","close","clearTimeout","Provider","value","useNotifications","context","Error"],"sources":["D:/Collabryta/collabryta-frontend/src/context/NotificationContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react';\r\nimport { notificationService, Notification } from '../services/notificationService';\r\n\r\ninterface NotificationContextType {\r\n    notifications: Notification[];\r\n    unreadCount: number;\r\n    addNotification: (notification: Notification) => void;\r\n    markAsRead: (id: number) => Promise<void>;\r\n    markAllAsRead: () => Promise<void>;\r\n    subscribe: (type: string, callback: (data: any) => void) => () => void;\r\n}\r\n\r\nconst NotificationContext = createContext<NotificationContextType | undefined>(undefined);\r\n\r\nexport const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [notifications, setNotifications] = useState<Notification[]>([]);\r\n    const [unreadCount, setUnreadCount] = useState(0);\r\n    const listeners = useRef<{ [type: string]: ((data: any) => void)[] }>({});\r\n\r\n    const subscribe = useCallback((type: string, callback: (data: any) => void) => {\r\n        if (!listeners.current[type]) {\r\n            listeners.current[type] = [];\r\n        }\r\n        listeners.current[type].push(callback);\r\n        return () => {\r\n            listeners.current[type] = listeners.current[type].filter(cb => cb !== callback);\r\n        };\r\n    }, []);\r\n\r\n    const fetchNotifications = useCallback(async () => {\r\n        const token = localStorage.getItem('token');\r\n        if (!token) return;\r\n        try {\r\n            const data = await notificationService.getNotifications(0, 50);\r\n            setNotifications(data);\r\n            setUnreadCount(data.filter(n => !n.is_read).length);\r\n        } catch (err) {\r\n            console.error('Error fetching notifications:', err);\r\n        }\r\n    }, []);\r\n\r\n    const addNotification = useCallback((notification: Notification) => {\r\n        setNotifications(prev => [notification, ...prev]);\r\n        setUnreadCount(prev => prev + 1);\r\n    }, []);\r\n\r\n    const markAsRead = async (id: number) => {\r\n        try {\r\n            await notificationService.markAsRead(id);\r\n            setNotifications(prev => prev.map(n => n.id === id ? { ...n, is_read: true } : n));\r\n            setUnreadCount(prev => Math.max(0, prev - 1));\r\n        } catch (err) {\r\n            console.error('Error marking as read:', err);\r\n        }\r\n    };\r\n\r\n    const markAllAsRead = async () => {\r\n        try {\r\n            await notificationService.markAllAsRead();\r\n            setNotifications(prev => prev.map(n => ({ ...n, is_read: true })));\r\n            setUnreadCount(0);\r\n        } catch (err) {\r\n            console.error('Error marking all as read:', err);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchNotifications();\r\n\r\n        const token = localStorage.getItem('token');\r\n        if (!token) return;\r\n\r\n        const wsUrl = `ws://localhost:8000/api/v1/ws?token=${token}`;\r\n        let ws: WebSocket;\r\n        let reconnectTimeout: any;\r\n\r\n        const connect = () => {\r\n            ws = new WebSocket(wsUrl);\r\n\r\n            ws.onmessage = (event) => {\r\n                try {\r\n                    const message = JSON.parse(event.data);\r\n                    if (message.type && listeners.current[message.type]) {\r\n                        listeners.current[message.type].forEach(cb => cb(message.data));\r\n                    }\r\n                    if (message.type === 'notification') {\r\n                        addNotification(message.data);\r\n                    }\r\n                } catch (err) {\r\n                    console.error('Error parsing WS message:', err);\r\n                }\r\n            };\r\n\r\n            ws.onclose = () => {\r\n                reconnectTimeout = setTimeout(connect, 5000);\r\n            };\r\n        };\r\n\r\n        connect();\r\n\r\n        return () => {\r\n            if (ws) ws.close();\r\n            clearTimeout(reconnectTimeout);\r\n        };\r\n    }, [fetchNotifications, addNotification]);\r\n\r\n    return (\r\n        <NotificationContext.Provider value={{ notifications, unreadCount, addNotification, markAsRead, markAllAsRead, subscribe }}>\r\n            {children}\r\n        </NotificationContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useNotifications = () => {\r\n    const context = useContext(NotificationContext);\r\n    if (context === undefined) {\r\n        throw new Error('useNotifications must be used within a NotificationProvider');\r\n    }\r\n    return context;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}